<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/blog/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="向终身学习者致敬">
<meta property="og:type" content="website">
<meta property="og:title" content="ttbb玩代码">
<meta property="og:url" content="http://steven-ji.github.io/blog/index.html">
<meta property="og:site_name" content="ttbb玩代码">
<meta property="og:description" content="向终身学习者致敬">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ttbb玩代码">
<meta name="twitter:description" content="向终身学习者致敬">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://steven-ji.github.io/blog/"/>





  <title>ttbb玩代码</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3052eff79e5b319c50246c1e59822cc0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">


  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ttbb玩代码</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/blog/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/blog/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/blog/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <input type="text" id="local-search-input" placeholder="search my blog...">
  <div id="local-search-result"></div>
  <span class="popup-btn-close">close</span>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://steven-ji.github.io/blog/blog/2018/10/22/Redis发布-订阅/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="溏溏爸爸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ttbb玩代码">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2018/10/22/Redis发布-订阅/" itemprop="url">Redis发布/订阅</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-22T14:24:37+08:00">
                2018-10-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  21
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Foreward"><a href="#Foreward" class="headerlink" title="Foreward"></a>Foreward</h2><p>redis的发布/订阅功能,可以说</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><h3 id="Advanced-Redis-Subscribe-Script-to-Pub-Sub-Channel"><a href="#Advanced-Redis-Subscribe-Script-to-Pub-Sub-Channel" class="headerlink" title="Advanced Redis: Subscribe Script to Pub/Sub Channel"></a><a href="https://matt.sh/advanced-redis-pubsub-scripts" target="_blank" rel="noopener">Advanced Redis: Subscribe Script to Pub/Sub Channel</a></h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://steven-ji.github.io/blog/blog/2018/10/22/Redis分布式锁/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="溏溏爸爸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ttbb玩代码">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2018/10/22/Redis分布式锁/" itemprop="url">Redis分布式锁</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-22T11:30:52+08:00">
                2018-10-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  453
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Foreward"><a href="#Foreward" class="headerlink" title="Foreward"></a>Foreward</h2><p>正好有业务场景需要使用分布式锁,读到这篇文章,非常好,做下摘录.</p>
<ul>
<li><p><a href="http://www.importnew.com/27477.html" target="_blank" rel="noopener">Redis 分布式锁的正确实现方式（ Java 版 ）</a></p>
</li>
<li><p><a href="http://www.redis.cn/commands/set.html" target="_blank" rel="noopener">Set Command</a></p>
</li>
</ul>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><ul>
<li>RedisKey设置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public class RedisKey &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 正则表达式.</span><br><span class="line">     */</span><br><span class="line">    public static final String REGEX = &quot;\\&#123;[a-zA-Z0-9]*\\&#125;&quot;;</span><br><span class="line">    /**</span><br><span class="line">     * 全局独自执行任务.</span><br><span class="line">     */</span><br><span class="line">    public static final String EXEC_LOCK = &quot;exec:lock&quot;;</span><br><span class="line">    /**</span><br><span class="line">     * 和锁配合使用,每个客户端一个标志.</span><br><span class="line">     */</span><br><span class="line">    private static final String OWNER_ID = UUID.randomUUID().toString();</span><br><span class="line">    /**</span><br><span class="line">     * 获取执行指定任务权限key.</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static String getExecLock(Object... objs) &#123;</span><br><span class="line">        return replaceKey(EXEC_LOCK, objs);</span><br><span class="line">    &#125;</span><br><span class="line">    private static String replaceKey(String key, Object... objs) &#123;</span><br><span class="line">        for (Object obj : objs) &#123;</span><br><span class="line">            key = key.replaceFirst(REGEX, String.valueOf(obj));</span><br><span class="line">        &#125;</span><br><span class="line">        return key;</span><br><span class="line">    &#125;</span><br><span class="line">    public static String getOwnerId() &#123;</span><br><span class="line">        return OWNER_ID;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>RedisService服务工具类</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">public class RedisService &#123;  </span><br><span class="line">    /**</span><br><span class="line">     * Only set the key if it does not already exist.</span><br><span class="line">     */</span><br><span class="line">    private static final String SET_IF_NOT_EXIST = &quot;NX&quot;;</span><br><span class="line">    /**</span><br><span class="line">     * Set the specified expire time, in milliseconds.</span><br><span class="line">     */</span><br><span class="line">    private static final String SET_WITH_EXPIRE_MILL_TIME = &quot;PX&quot;;</span><br><span class="line">    /**</span><br><span class="line">     * Set the specified expire time, in seconds.</span><br><span class="line">     */</span><br><span class="line">    private static final String SET_WITH_EXPIRE_SECOND_TIME = &quot;EX&quot;;</span><br><span class="line">    private static final String LOCK_SUCCESS = &quot;OK&quot;;</span><br><span class="line">    private static final Long RELEASE_SUCCESS = 1L;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * 设置分布式锁.(过期时间毫秒)</span><br><span class="line">     * @param lockKey    锁的名称.</span><br><span class="line">     * @param requestId  持锁人ID.</span><br><span class="line">     * @param expireTime 锁的超时时间.</span><br><span class="line">     * @return 是否获取锁.</span><br><span class="line">     */</span><br><span class="line">    public synchronized boolean tryGetDistributeLock(String lockKey, String requestId, int expireTime) &#123;</span><br><span class="line">        log.debug(&quot;lock key: &#123;&#125;, ownerId: &#123;&#125;, expire time: &#123;&#125;&quot;, lockKey, requestId, expireTime);</span><br><span class="line">        String result = jedis.set(lockKey, requestId, SET_IF_NOT_EXIST, SET_WITH_EXPIRE_MILL_TIME, expireTime);</span><br><span class="line">        if (LOCK_SUCCESS.equals(result)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 释放分布式锁.</span><br><span class="line">     *</span><br><span class="line">     * @param lockKey   锁</span><br><span class="line">     * @param requestId 请求标识</span><br><span class="line">     * @return 是否释放成功.</span><br><span class="line">     */</span><br><span class="line">    public synchronized boolean releaseDistributedLock(String lockKey, String requestId) &#123;</span><br><span class="line">        log.debug(&quot;release lock key: &#123;&#125;, ownerId: &#123;&#125;, expire time: &#123;&#125;&quot;, lockKey, requestId);</span><br><span class="line">        String script = &quot;if redis.call(&apos;get&apos;, KEYS[1]) == ARGV[1] then return redis.call(&apos;del&apos;, KEYS[1]) else return 0 end&quot;;</span><br><span class="line">        Object result = jedis.eval(script, Collections.singletonList(lockKey), Collections.singletonList(requestId));</span><br><span class="line">        if (RELEASE_SUCCESS.equals(result)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://steven-ji.github.io/blog/blog/2018/10/15/生成自签名证书/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="溏溏爸爸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ttbb玩代码">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2018/10/15/生成自签名证书/" itemprop="url">生成自签名根证书</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-15T14:36:49+08:00">
                2018-10-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Nginx/" itemprop="url" rel="index">
                    <span itemprop="name">Nginx</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,184
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul>
<li>mac 10.13.6, LibreSSL 2.2.7</li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>对于数字签名、证书、CA、Https的相关概念一直都很混乱.参考了相关资料后,并记录.</p>
<ul>
<li><p>公钥、私钥</p>
<p>用于对数据进行加密、解密.</p>
</li>
<li><p>摘要(digest)、数字签名(signature)</p>
<p>摘要,是对数据进行hash运算后的数据; 数字签名(signature),使用公(私)钥对摘要进行加密后的数据.</p>
</li>
<li><p>CA(Certificate Authority)证书中心、数字证书(Digest Certificate)</p>
<p>CA(证书中心)用自己的私钥,对用户公钥、用户个人信息进行加密,生成数字证书(Digest Certificate).</p>
</li>
<li><p>SSL握手过程</p>
<ul>
<li><p>客户端向服务器发请求，请求证书</p>
</li>
<li><p>服务器把证书发给客户端</p>
</li>
<li><p>客户端一般会有大部分CA的公钥，客户端收到证书后，检查该颁发者是否是客户端认可的CA，如果是，就用该CA的公钥解密数字签名，然后再计算</p>
<p>证书中的”公钥和证书信息“的hash值，比较两者，如果相同，那就说明该证书没有被人篡改过，而且是该CA机构颁发的。当然，还会进行其它验证，<br>如证书的common name与http request header中的host（不包括端口）是否相同，等等，如果有哪项检查不通过，会有告警，如果所有检查通过，<br>那进入下一步。</p>
</li>
<li><p>客户端生成对称密钥，用证书中的公钥加密，发给服务器</p>
</li>
<li><p>服务器收到对称密钥后保存，给客户端一个应答。</p>
</li>
<li><p>客户端接收响应，这样就完成了SSL连接，后面的通信用对称密钥加密数据传输。  </p>
<p>因为非对称加密相对对称加密来说比较耗时，所以正式的数据传输是用对称加密算法。非对称加密只是用于建立SSL时对称密钥的安全传输。我们可以设置</p>
</li>
</ul>
</li>
</ul>
<p>HTTPS长连接，这样建立好SSL+HTTP连接后，可以用这个连接发多次HTTPS请求，而不用每次请求都建立连接。</p>
<h2 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h2><p>详细信息参考<a href="https://www.openssl.org/docs/man1.1.1/man1/openssl-req.html" target="_blank" rel="noopener">req</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 生成一个RSA私钥,1024是加密强度，一般是1024或2048 </span><br><span class="line">$ openssl genrsa -out private.key 2048</span><br><span class="line"> </span><br><span class="line"># 生成一个证书请求</span><br><span class="line">$ openssl req -new -key private.key -out cert_req.csr</span><br><span class="line"></span><br><span class="line"># 自己签发证书，如果要权威CA签发的话，要把cert_req.csr发给CA</span><br><span class="line">$ openssl x509 -req -days 3650 -in cert_req.csr -signkey private.key -out server_cert.crt</span><br><span class="line">只需要两处填写就行,其他都不填.</span><br><span class="line">...</span><br><span class="line">Common Name (eg, fully qualified host name) []:这里填域名</span><br><span class="line">...</span><br><span class="line">A challenge password []:密码</span><br></pre></td></tr></table></figure>
<ul>
<li>使用自签名脚本</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./gencrt.sh </span><br><span class="line">输入域名和密码即可,这里输入域名gitlab.example.com,则生成以下4个文件</span><br><span class="line">gitlab.example.com.crt：自签名的证书</span><br><span class="line">gitlab.example.com.csr：证书的请求</span><br><span class="line">gitlab.example.com.key：不带口令的Key</span><br><span class="line">gitlab.example.com.origin.key：带口令的Key</span><br><span class="line">只要使用.crt和com.key即可.</span><br></pre></td></tr></table></figure>
<h2 id="Nginx使用"><a href="#Nginx使用" class="headerlink" title="Nginx使用"></a>Nginx使用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 启动nginx</span><br><span class="line">$ docker run --name mynginx -p 8080:80 -d nginx</span><br><span class="line"># 拷贝nginx的配置文件到本地,并重命名文件夹为conf</span><br><span class="line">$ docker cp mynginx:/etc/nginx /opt/nginx</span><br><span class="line">$ mv /opt/nginx/nginx /opt/nginx/conf/certs下</span><br><span class="line"># 删除容器</span><br><span class="line">$ docker rm -f mynginx</span><br><span class="line"># 拷贝密钥到/opt/nginx/conf/certs下</span><br><span class="line">$ cp gitlab.example.com.crt gitlab.example.com.key /opt/nginx/conf/certs</span><br><span class="line"># 设置证书.在配置文件最后添加内容.</span><br><span class="line">$ vim /opt/nginx/conf/conf.d/default.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    ssl                      on;</span><br><span class="line">    ssl_certificate          /etc/nginx/certs/gitlab.example.com.crt;</span><br><span class="line">    ssl_certificate_key      /etc/nginx/certs/gitlab.example.com.key;</span><br><span class="line"></span><br><span class="line">    ssl_session_timeout  5m;</span><br><span class="line"></span><br><span class="line">    ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">    ssl_prefer_server_ciphers   on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"># 启动</span><br><span class="line">$ docker run --name mynginx -v /opt/nginx/conf:/etc/nginx -p 8080:80 -p 8081:443 -d nginx</span><br><span class="line"># 浏览器验证即可.</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://jverson.com/2017/03/02/https/" target="_blank" rel="noopener">Nginx 配置自签名证书支持 https</a></li>
<li><a href="https://www.openssl.org/docs/manpages.html" target="_blank" rel="noopener">OpenSSL Document</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html" target="_blank" rel="noopener">数字签名是什么?阮一峰</a></li>
<li><a href="https://www.cnblogs.com/ajianbeyourself/p/3898911.html" target="_blank" rel="noopener">数字证书、SSL、HTTPS及在Nginx中的配置</a></li>
</ul>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="自签名脚本"><a href="#自签名脚本" class="headerlink" title="自签名脚本"></a>自签名脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ vim gencrt.sh</span><br><span class="line">#!/bin/sh</span><br><span class="line"># create self-signed server certificate:</span><br><span class="line">read -p &quot;Enter your domain [www.example.com]: &quot; DOMAIN</span><br><span class="line"></span><br><span class="line">echo &quot;Create server key...&quot;</span><br><span class="line"></span><br><span class="line">openssl genrsa -des3 -out $DOMAIN.key 2048</span><br><span class="line"></span><br><span class="line">echo &quot;Create server certificate signing request...&quot;</span><br><span class="line"></span><br><span class="line">SUBJECT=&quot;/C=US/ST=Mars/L=iTranswarp/O=iTranswarp/OU=iTranswarp/CN=$DOMAIN&quot;</span><br><span class="line"></span><br><span class="line">openssl req -new -subj $SUBJECT -key $DOMAIN.key -out $DOMAIN.csr</span><br><span class="line"></span><br><span class="line">echo &quot;Remove password...&quot;</span><br><span class="line"></span><br><span class="line">mv $DOMAIN.key $DOMAIN.origin.key</span><br><span class="line">openssl rsa -in $DOMAIN.origin.key -out $DOMAIN.key</span><br><span class="line"></span><br><span class="line">echo &quot;Sign SSL certificate...&quot;</span><br><span class="line"></span><br><span class="line">openssl x509 -req -days 3650 -in $DOMAIN.csr -signkey $DOMAIN.key -out $DOMAIN.crt</span><br><span class="line"></span><br><span class="line">echo &quot;TODO:&quot;</span><br><span class="line">echo &quot;Copy $DOMAIN.crt to /etc/nginx/ssl/$DOMAIN.crt&quot;</span><br><span class="line">echo &quot;Copy $DOMAIN.key to /etc/nginx/ssl/$DOMAIN.key&quot;</span><br><span class="line">echo &quot;Add configuration in nginx:&quot;</span><br><span class="line">echo &quot;server &#123;&quot;</span><br><span class="line">echo &quot;    ...&quot;</span><br><span class="line">echo &quot;    listen 443 ssl;&quot;</span><br><span class="line">echo &quot;    ssl_certificate     /etc/nginx/ssl/$DOMAIN.crt;&quot;</span><br><span class="line">echo &quot;    ssl_certificate_key /etc/nginx/ssl/$DOMAIN.key;&quot;</span><br><span class="line">echo &quot;&#125;&quot;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://steven-ji.github.io/blog/blog/2018/10/15/docker之实战技巧/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="溏溏爸爸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ttbb玩代码">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2018/10/15/docker之实战技巧/" itemprop="url">docker之实用技巧</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-15T10:33:23+08:00">
                2018-10-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  448
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这里记录自己常用的一些实战技巧.</p>
<h2 id="技巧一"><a href="#技巧一" class="headerlink" title="技巧一"></a>技巧一</h2><h3 id="容器执行指定命令并后台运行"><a href="#容器执行指定命令并后台运行" class="headerlink" title="容器执行指定命令并后台运行"></a>容器执行指定命令并后台运行</h3><p>容器是否会长久运行，是和 docker run 指定的命令有关，和 -d 参数无关.<br>我就有以下场景需求.制作一个squid镜像,并在运行容器后,容器里执行squid start命令.<br>一般需要让容器可以后台长久运行,需要指定/bin/bash指令.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -ti --name [容器名] -d [镜像名] /bin/bash</span><br></pre></td></tr></table></figure></p>
<h4 id="方式一-通过Dockerfile来build"><a href="#方式一-通过Dockerfile来build" class="headerlink" title="方式一:通过Dockerfile来build"></a>方式一:通过Dockerfile来build</h4><p>利用ENTRYPOINT实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:7</span><br><span class="line">RUN yum install -y squid</span><br><span class="line"># ip高匿与端口</span><br><span class="line">RUN echo &apos;request_header_access Via deny all&apos; &gt;&gt; /etc/squid/squid.conf \</span><br><span class="line"> &amp;&amp; echo &apos;request_header_access X-Forwarded-For deny all&apos; &gt;&gt; /etc/squid/squid.conf \</span><br><span class="line"> &amp;&amp; echo &apos;request_header_access From deny all&apos; &gt;&gt; /etc/squid/squid.conf \</span><br><span class="line"> &amp;&amp; sed -i &apos;s/http_access deny all/http_access allow all/g&apos; /etc/squid/squid.conf \</span><br><span class="line"> &amp;&amp; sed -i &apos;s/http_port 3128/http_port 57112/g&apos; /etc/squid/squid.conf</span><br><span class="line">ENTRYPOINT /usr/sbin/squid start &amp;&amp; /bin/bash # 这个是重点</span><br><span class="line">EXPOSE 57112</span><br></pre></td></tr></table></figure></p>
<h4 id="方式二-使用supervisor-有问题-待修改"><a href="#方式二-使用supervisor-有问题-待修改" class="headerlink" title="方式二:使用supervisor(有问题,待修改)"></a>方式二:使用supervisor(有问题,待修改)</h4><p>1、容器中需要安装supervisor服务;<br>2、上传本地supervisor配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:7</span><br><span class="line">RUN yum install -y squid python-setuptools</span><br><span class="line">RUN easy_install supervisor</span><br><span class="line">COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf</span><br><span class="line"># ip高匿与端口</span><br><span class="line">RUN echo &apos;request_header_access Via deny all&apos; &gt;&gt; /etc/squid/squid.conf \</span><br><span class="line"> &amp;&amp; echo &apos;request_header_access X-Forwarded-For deny all&apos; &gt;&gt; /etc/squid/squid.conf \</span><br><span class="line"> &amp;&amp; echo &apos;request_header_access From deny all&apos; &gt;&gt; /etc/squid/squid.conf \</span><br><span class="line"> &amp;&amp; sed -i &apos;s/http_access deny all/http_access allow all/g&apos; /etc/squid/squid.conf \</span><br><span class="line"> &amp;&amp; sed -i &apos;s/http_port 3128/http_port 57112/g&apos; /etc/squid/squid.conf</span><br><span class="line">EXPOSE 57112</span><br></pre></td></tr></table></figure></p>
<h5 id="supervisor配置文件"><a href="#supervisor配置文件" class="headerlink" title="supervisor配置文件"></a>supervisor配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[supervisord]</span><br><span class="line">nodaemon=true</span><br><span class="line">[program:squid]</span><br><span class="line">command=/usr/sbin/squid start</span><br></pre></td></tr></table></figure>
<h2 id="技巧二"><a href="#技巧二" class="headerlink" title="技巧二"></a>技巧二</h2><h3 id="Docker-Hub-自动构建"><a href="#Docker-Hub-自动构建" class="headerlink" title="Docker Hub 自动构建"></a>Docker Hub 自动构建</h3><ul>
<li>参考:<a href="https://blog.csdn.net/u010246789/article/details/54234217" target="_blank" rel="noopener">https://blog.csdn.net/u010246789/article/details/54234217</a></li>
<li><a href="http://imquanquan.net/archives/pull-images-to-dockerhub-and-autobuild.html" target="_blank" rel="noopener">http://imquanquan.net/archives/pull-images-to-dockerhub-and-autobuild.html</a></li>
</ul>
<h2 id="技巧三"><a href="#技巧三" class="headerlink" title="技巧三"></a>技巧三</h2><h3 id="本地阅读Docker官方文档"><a href="#本地阅读Docker官方文档" class="headerlink" title="本地阅读Docker官方文档"></a>本地阅读Docker官方文档</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 本地运行Docker官方文档网站</span><br><span class="line">$ docker run -d -p 80:4000 docs/docker.github.io</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://steven-ji.github.io/blog/blog/2018/10/15/docker之安装-新/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="溏溏爸爸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ttbb玩代码">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2018/10/15/docker之安装-新/" itemprop="url">docker之安装(新)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-15T10:27:36+08:00">
                2018-10-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  349
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul>
<li>mac 10.13.4 , Docker version 18.03.1-ce,Centos7</li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>目前docker提供ce(community edition)社区版本和ee(enterprise edition)企业版本.选择ce版本即可.</p>
<h3 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h3><p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fw8pa4d93nj31kw0e27lx.jpg" alt="img"></p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fw8paisws6j31kw0yedl4.jpg" alt="img"></p>
<h2 id="Centos7安装"><a href="#Centos7安装" class="headerlink" title="Centos7安装"></a>Centos7安装</h2><h3 id="安装CE版本"><a href="#安装CE版本" class="headerlink" title="安装CE版本"></a>安装CE版本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 卸载旧版本</span><br><span class="line">$ yum remove docker \</span><br><span class="line">                  docker-ce \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-selinux \</span><br><span class="line">                  docker-engine-selinux \</span><br><span class="line">                  docker-engine</span><br><span class="line"># 为了防止之前已经安装的遗留问题,删除镜像储存目录</span><br><span class="line">$ rm -rf /var/lib/docker</span><br><span class="line"># 安装依赖工具</span><br><span class="line">$ yum install -y yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br><span class="line"># 安装docker官方仓库(失败 使用阿里云仓库)</span><br><span class="line">$ yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"># 如果上面执行后如下报错,添加阿里云的源即可.</span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">adding repo from: https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">grabbing file https://download.docker.com/linux/centos/docker-ce.repo to /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">Could not fetch/save url https://download.docker.com/linux/centos/docker-ce.repo to file /etc/yum.repos.d/docker-ce.repo: [Errno 12] Timeout on https://download.docker.com/linux/centos/docker-ce.repo: (28, &apos;Resolving timed out after 30455 milliseconds&apos;)</span><br><span class="line">$ yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"># 安装docker</span><br><span class="line">$ yum install -y docker-ce</span><br><span class="line"># 启动</span><br><span class="line">$ systemctl enable docker &amp;&amp; systemctl start docker</span><br></pre></td></tr></table></figure>
<h3 id="添加docker-hub中国官方镜像加速器"><a href="#添加docker-hub中国官方镜像加速器" class="headerlink" title="添加docker hub中国官方镜像加速器"></a>添加docker hub<a href="https://www.docker-cn.com/registry-mirror" target="_blank" rel="noopener">中国官方镜像加速器</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://registry.docker-cn.com&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.docker.com/get-docker" target="_blank" rel="noopener">docker document</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://steven-ji.github.io/blog/blog/2018/10/15/docker常见问题汇总/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="溏溏爸爸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ttbb玩代码">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2018/10/15/docker常见问题汇总/" itemprop="url">docker常见问题汇总</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-15T10:24:37+08:00">
                2018-10-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  248
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="常见问题汇总"><a href="#常见问题汇总" class="headerlink" title="常见问题汇总"></a>常见问题汇总</h2><h3 id="阿里云启动报错-error-initializing-graphdriver-driver-not-supported"><a href="#阿里云启动报错-error-initializing-graphdriver-driver-not-supported" class="headerlink" title="阿里云启动报错:error initializing graphdriver: driver not supported"></a>阿里云启动报错:error initializing graphdriver: driver not supported</h3><ul>
<li><p>问题描述<br>从版本docker-ce-18.06.0.ce降到版本docker-ce-17.03.2.ce,不能启动.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ journalctl -xe</span><br><span class="line">.....</span><br><span class="line">Aug 08 14:27:12 es3-log systemd[1]: Starting Docker Application Container Engine...</span><br><span class="line">Aug 08 14:27:12 es3-log dockerd[23468]: time=&quot;2018-08-08T14:27:12.282682284+08:00&quot; level=info msg=&quot;libcontainerd: new con...23476&quot;</span><br><span class="line">Aug 08 14:27:13 es3-log dockerd[23468]: time=&quot;2018-08-08T14:27:13.286553501+08:00&quot; level=error msg=&quot;[graphdriver] prior s...orted&quot;</span><br><span class="line">Aug 08 14:27:13 es3-log dockerd[23468]: Error starting daemon: error initializing graphdriver: driver not supported</span><br><span class="line">Aug 08 14:27:13 es3-log systemd[1]: docker.service: main process exited, code=exited, status=1/FAILURE</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
</li>
<li><p>解决方案<br>删除docker镜像存放目录/var/lib/docker,猜测是新版本目录结构与老版本不通导致.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># docker-ce-17.03.2.ce版本/var/lib/docker目录</span><br><span class="line">containers image network overlay plugins swarm tmp trust volumes</span><br><span class="line"># docker-ce-18.06.0.ce版本/var/lib/docker目录</span><br><span class="line">builder buildkit containerd containers image network overlay2 plugins runtimes	swarm tmp trust volumes</span><br><span class="line">$ rm -rf /var/lib/docker</span><br></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://steven-ji.github.io/blog/blog/2018/10/15/docker实战之jenkins集群/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="溏溏爸爸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ttbb玩代码">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2018/10/15/docker实战之jenkins集群/" itemprop="url">docker实战之jenkins集群</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-15T10:12:41+08:00">
                2018-10-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,343
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  7
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul>
<li>centos 7</li>
<li>jenkins 2.121.1</li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>jenkins集群是必须搭建的,可以提高部署效率,每次只是部署几个job自然不会出现问题,如果一次要执行100个呢?试过就知道有多慢了!</p>
<h2 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h2><p>jenkins-master只负责分发构建任务.</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fw8owhub28j31kw0s47a1.jpg" alt="img"></p>
<p>搭建之前,我先把几个关键点梳理下:</p>
<ul>
<li>jenkins主节点创建job到目标部署主机的ssh免密登录密钥信息,在集群中的jenkins从节点如何获取?</li>
<li>jenkins主节点数据必须持久化到本地磁盘</li>
</ul>
<h3 id="Pull-jenkins-images"><a href="#Pull-jenkins-images" class="headerlink" title="Pull jenkins images"></a>Pull jenkins images</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull jenkins/jenkins:lts</span><br></pre></td></tr></table></figure>
<h3 id="Jenkins-master-and-Mount-data-volume"><a href="#Jenkins-master-and-Mount-data-volume" class="headerlink" title="Jenkins master and Mount data volume"></a>Jenkins master and Mount data volume</h3><h4 id="Build-Dockerfile-jenkins-data-and-jenkins-master"><a href="#Build-Dockerfile-jenkins-data-and-jenkins-master" class="headerlink" title="Build Dockerfile: jenkins-data and jenkins-master"></a>Build Dockerfile: jenkins-data and jenkins-master</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -f jenkins-data-dockerfile -t jenkins-data .</span><br><span class="line">$ docker build -f jenkins-master-dockerfile -t jenins-master .</span><br><span class="line"># 从节点宿主机上执行</span><br><span class="line">$ docker build -f jenkins-slave-dockerfile -t jenins-slave .</span><br></pre></td></tr></table></figure>
<h4 id="Run-jenkins-master"><a href="#Run-jenkins-master" class="headerlink" title="Run jenkins-master"></a>Run jenkins-master</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 创建用户持久化jenkins数据文件的目录及日志目录.</span><br><span class="line">$ mkdir -p &#123;/data/jenkins,/data/logs/jenkins&#125;</span><br><span class="line"># 容器内启动jenkins服务使用的是jenkins用户,所以必须修改目录用户拥有者为</span><br><span class="line">$ chown 1000:1000 &#123;/data/jenkins,/data/logs/jenkins&#125;</span><br><span class="line"># 启动数据卷jenkins-datas</span><br><span class="line">$ docker run --name jenkins-data \</span><br><span class="line">-v /data/jenkins:/var/jenkins_home \</span><br><span class="line">-v /data/logs/jenkins:/var/log/jenkins \</span><br><span class="line">jenkins-data</span><br><span class="line"># 启动jenkins-master.(构建dockerfile见附录.)</span><br><span class="line">$ docker run -d \</span><br><span class="line">-p 19875:8080 \</span><br><span class="line">-p 50000:50000 \</span><br><span class="line">--volumes-from jenkins-data \</span><br><span class="line">--name jenkins-master \</span><br><span class="line">jenkins-master</span><br></pre></td></tr></table></figure>
<h4 id="Run-jenkins-slave-in-slave-machine"><a href="#Run-jenkins-slave-in-slave-machine" class="headerlink" title="Run jenkins-slave in slave machine"></a>Run jenkins-slave in slave machine</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -ti -d \</span><br><span class="line">-p 19222:22 \</span><br><span class="line">--restart on-failure \</span><br><span class="line">--network host \ </span><br><span class="line">--name jenkins-slave \</span><br><span class="line">jenkins-slave</span><br></pre></td></tr></table></figure>
<h3 id="Jenkins-master-add-slave-node"><a href="#Jenkins-master-add-slave-node" class="headerlink" title="Jenkins master add slave node"></a>Jenkins master add slave node</h3><h4 id="添加登录slave的用户名密码"><a href="#添加登录slave的用户名密码" class="headerlink" title="添加登录slave的用户名密码"></a>添加登录slave的用户名密码</h4><p>Jenkins-&gt;Credentials</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fw8owuiwo9j31kw0uv165.jpg" alt="img"></p>
<p>这里可以添加root用户,避免一些权限问题.</p>
<h4 id="添加节点"><a href="#添加节点" class="headerlink" title="添加节点"></a>添加节点</h4><p>Jenkins-&gt;系统管理-&gt;管理节点</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fw8ox2zmvzj31kw0upn4l.jpg" alt="img"></p>
<p>指定远程工作目录,如果是用jenkins_slave用户时注意/home/jenkins_home需要jenkins_slave权限.为了方便起见,这里就直接使用root用户</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fw8oxb0mqpj31kw0uq7de.jpg" alt="img"></p>
<h3 id="同步jenkins-master的密钥及相关脚本"><a href="#同步jenkins-master的密钥及相关脚本" class="headerlink" title="同步jenkins-master的密钥及相关脚本"></a>同步jenkins-master的密钥及相关脚本</h3><p>这里我采用的做法是配置job,通过job将.ssh/id_rsa, .ssh/id_rsa.pub,.ssh/known_hosts拷贝到slave中(见rsa_sysnc.sh脚本).<br>(所有脚本<a href="https://github.com/steven-ji/proxy-scripts.git" target="_blank" rel="noopener">proxy-scripts</a>已同步到git上.)</p>
<h4 id="新建同步job"><a href="#新建同步job" class="headerlink" title="新建同步job"></a>新建同步job</h4><p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fw8oxhw1j2j31ie0j63zx.jpg" alt="img"></p>
<h2 id="上传dockerfile到docker-hub个人仓库"><a href="#上传dockerfile到docker-hub个人仓库" class="headerlink" title="上传dockerfile到docker hub个人仓库."></a>上传dockerfile到docker hub个人仓库.</h2><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><h3 id="Getting-started-with-Docker-官方-推荐"><a href="#Getting-started-with-Docker-官方-推荐" class="headerlink" title="Getting started with Docker 官方,推荐"></a><a href="https://jenkins.io/solutions/docker/" target="_blank" rel="noopener">Getting started with Docker</a> 官方,推荐</h3><h3 id="Docker-Volume-之权限管理"><a href="#Docker-Volume-之权限管理" class="headerlink" title="Docker Volume 之权限管理"></a><a href="https://www.cnblogs.com/jackluo/p/5783116.html" target="_blank" rel="noopener">Docker Volume 之权限管理</a></h3><h3 id="Get-Started-with-Jenkins-2-0-with-Docker"><a href="#Get-Started-with-Jenkins-2-0-with-Docker" class="headerlink" title="Get Started with Jenkins 2.0 with Docker"></a><a href="https://www.cloudbees.com/blog/get-started-jenkins-20-docker" target="_blank" rel="noopener">Get Started with Jenkins 2.0 with Docker</a></h3><h3 id="Official-Jenkins-Docker-image"><a href="#Official-Jenkins-Docker-image" class="headerlink" title="Official Jenkins Docker image"></a><a href="https://github.com/jenkinsci/docker/blob/master/README.md" target="_blank" rel="noopener">Official Jenkins Docker image</a></h3><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="jenkins-data-dockerfile"><a href="#jenkins-data-dockerfile" class="headerlink" title="jenkins-data-dockerfile"></a>jenkins-data-dockerfile</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ vim jenkins-data-dockerfile</span><br><span class="line">FROM debian:jessie</span><br><span class="line"># Create the jenkins user</span><br><span class="line">RUN useradd -d &quot;/var/jenkins_home&quot; -u 1000 -m -s /bin/bash jenkins</span><br><span class="line"># Create the folders and volume mount points</span><br><span class="line">RUN mkdir -p /var/log/jenkins</span><br><span class="line">RUN chown -R jenkins:jenkins /var/log/jenkins</span><br><span class="line">VOLUME [&quot;/var/log/jenkins&quot;, &quot;/var/jenkins_home&quot;]</span><br><span class="line">USER jenkins</span><br><span class="line">CMD [&quot;echo&quot;, &quot;Data container for Jenkins&quot;]</span><br></pre></td></tr></table></figure>
<h3 id="jenkins-master-dockerfile-待补充插件列表"><a href="#jenkins-master-dockerfile-待补充插件列表" class="headerlink" title="jenkins-master-dockerfile(待补充插件列表)"></a>jenkins-master-dockerfile(待补充插件列表)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vim jenkins-master-dockerfile</span><br><span class="line">FROM jenkins/jenkins:lts</span><br><span class="line"># 增加swarm:3.13插件.https://plugins.jenkins.io/swarm</span><br><span class="line">USER root</span><br><span class="line">RUN /usr/local/bin/install-plugins.sh docker_swarm Ansible Multijob Pipeline</span><br><span class="line">USER jenkins</span><br></pre></td></tr></table></figure>
<h3 id="jenkins-slave-dockerfile"><a href="#jenkins-slave-dockerfile" class="headerlink" title="jenkins-slave-dockerfile"></a>jenkins-slave-dockerfile</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">FROM centos:centos7</span><br><span class="line"># 创建用户及修改密码</span><br><span class="line">RUN groupadd -g 1000 jenkins_slave</span><br><span class="line">RUN useradd -d /home/jenkins_home -s /bin/bash \</span><br><span class="line">-m jenkins_slave -u 1000 -g jenkins_slave</span><br><span class="line">RUN echo &apos;ys123456&apos; | passwd --stdin root</span><br><span class="line">RUN echo &apos;jpass&apos; | passwd --stdin jenkins_slave</span><br><span class="line"># 安装依赖包</span><br><span class="line">RUN yum install -y passwd openssl openssh-server wget git vim java-1.8.0-openjdk java-1.8.0-openjdk-devel ansible</span><br><span class="line"># 设置maven,安装路径保持和jenkins-master中的一致.</span><br><span class="line">RUN rm -rf /opt/apache-maven* &amp;&amp; \</span><br><span class="line">wget -O /opt/apache-maven-3.5.4.tar.gz http://mirrors.shu.edu.cn/apache/maven/maven-3/3.5.4/binaries/apache-maven-3.5.4-bin.tar.gz &amp;&amp; \</span><br><span class="line">tar -xvf /opt/apache-maven-3.5.4.tar.gz -C /opt/ &amp;&amp; \</span><br><span class="line">mv /opt/apache-maven-3.5.4 /opt/maven &amp;&amp; \</span><br><span class="line">rm -rf /opt/apache-maven-3.5.4 &amp;&amp; \</span><br><span class="line">rm -rf /opt/apache-maven-3.5.4.tar.gz &amp;&amp; \</span><br><span class="line">echo &quot;export MAVEN_HOME=/opt/maven&quot; &gt;&gt; /etc/profile &amp;&amp; \</span><br><span class="line">echo &apos;PATH=$PATH:$MAVEN_HOME/bin&apos; &gt;&gt; /etc/profile &amp;&amp; \</span><br><span class="line">source /etc/profile</span><br><span class="line"># 设置jdk,安装路径保持和jenkins-master中的一致.</span><br><span class="line">RUN mkdir -p /usr/local/java &amp;&amp; \</span><br><span class="line">wget --no-cookies \</span><br><span class="line">--no-check-certificate \</span><br><span class="line">--header &quot;Cookie: oraclelicense=accept-securebackup-cookie&quot; \</span><br><span class="line">http://download.oracle.com/otn-pub/java/jdk/8u171-b11/512cd62ec5174c3487ac17c61aaa89e8/jdk-8u171-linux-x64.tar.gz \</span><br><span class="line">-O /usr/local/java/jdk1.8.tar.gz</span><br><span class="line">RUN tar -xvf /usr/local/java/jdk1.8.tar.gz -C /usr/local/java &amp;&amp; mv /usr/local/java/jdk1.8.0_171 /usr/local/java/jdk1.8 &amp;&amp; echo &apos;export JAVA_HOME=/usr/local/java/jdk1.8&apos; &gt;&gt; /etc/profile &amp;&amp; echo &apos;PATH=$PATH:$JAVA_HOME/bin&apos; &amp;&amp; source /etc/profile</span><br><span class="line"># 设置jenkins_home目录,保持和jenkins-master一致.(根据需要自己修改路径)</span><br><span class="line">RUN mkdir -p /root/.jenkins &amp;&amp; echo &apos;export JENKINS_HOME=/root/.jenkins/&apos; &gt;&gt; /etc/profile &amp;&amp; source /etc/profile</span><br><span class="line"># 生成密钥</span><br><span class="line">RUN ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key -N &apos;&apos;</span><br><span class="line">RUN ssh-keygen -q -t ecdsa -f /etc/ssh/ssh_host_ecdsa_key -N &apos;&apos;</span><br><span class="line">RUN sed -i &apos;s|session required pam_loginuid.so|session optional pam_loginuid.so|g&apos; /etc/pam.d/sshd</span><br><span class="line">RUN mkdir -p /root/.ssh &amp;&amp; chown root.root /root &amp;&amp; chmod 700 /root/.ssh</span><br><span class="line"></span><br><span class="line"># 下载脚本.这里是因为脚本构建用到了许多脚本.</span><br><span class="line">RUN git clone https://github.com/steven-ji/proxy-scripts.git /opt/scripts</span><br><span class="line">RUN chown -R 1000:1000 /opt/scripts</span><br><span class="line"></span><br><span class="line">#设置时区</span><br><span class="line">RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; echo &apos;Asia/Shanghai&apos; &gt;/etc/timezone</span><br><span class="line"></span><br><span class="line">EXPOSE 22</span><br><span class="line"></span><br><span class="line">CMD ip addr ls eth0 | awk &apos;&#123;print $2&#125;&apos; | egrep -o &apos;([0-9]+\.)&#123;3&#125;[0-9]+&apos;;/usr/sbin/sshd -D</span><br></pre></td></tr></table></figure>
<h3 id="jenkins-slave-swarm-dockerfile"><a href="#jenkins-slave-swarm-dockerfile" class="headerlink" title="jenkins-slave-swarm-dockerfile"></a>jenkins-slave-swarm-dockerfile</h3><h2 id="碰到的问题"><a href="#碰到的问题" class="headerlink" title="碰到的问题"></a>碰到的问题</h2><h3 id="场景一-jenkins-master为较早创建-需要扩展jenkins-slave"><a href="#场景一-jenkins-master为较早创建-需要扩展jenkins-slave" class="headerlink" title="场景一:jenkins-master为较早创建,需要扩展jenkins-slave"></a>场景一:jenkins-master为较早创建,需要扩展jenkins-slave</h3><p>jenkins-master为较早创建的,其中全局工具配置里jdk路径、maven路径、工作空间路径等都是已经确定好的.在创建jenkins-slave时,需要保持与jenkins-master一致.(或者修改主master的相关路径)</p>
<ul>
<li>jdk安装路径一致</li>
<li>maven安装路径一致</li>
<li>工作空间(workspace)路径一致<br>jenkins-&gt;全局工具配置</li>
</ul>
<p>jenkins-&gt;系统设置<br>Jenkins默认的内置工作空间为系统用户的根目录下，其文件夹名称为”.jenkins”.如果设置了JENKINS_HOME则使用.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://steven-ji.github.io/blog/blog/2018/10/13/GitLab安装篇/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="溏溏爸爸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ttbb玩代码">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2018/10/13/GitLab安装篇/" itemprop="url">GitLab安装篇</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-13T17:03:57+08:00">
                2018-10-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Git/" itemprop="url" rel="index">
                    <span itemprop="name">Git</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,872
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  9
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Foreword"><a href="#Foreword" class="headerlink" title="Foreword"></a>Foreword</h2><p>最近准备迁移公司的svn仓库,记录下自己学习及迁移过程.</p>
<h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><p>GitLab目前提供三个版本:(以下都是docker镜像)</p>
<ul>
<li><a href="https://hub.docker.com/r/gitlab/gitlab-ce/" target="_blank" rel="noopener">GitLab Community Edition</a></li>
<li><a href="https://hub.docker.com/r/gitlab/gitlab-ee/" target="_blank" rel="noopener">GitLab Enterprise Edition</a></li>
<li><a href="https://hub.docker.com/r/gitlab/gitlab-runner/" target="_blank" rel="noopener">GitLab Runner</a></li>
</ul>
<p>只是为了满足基本使用,以CE版本安装.</p>
<h3 id="Run"><a href="#Run" class="headerlink" title="Run"></a>Run</h3><ul>
<li><p>运行环境要求</p>
<p>4G内存(最低2G)、4核或8核CPU</p>
</li>
</ul>
<p>启动GitLab是比较简单.但在正式开始使用之前,对它的配置有个全面的了解是很有必要的.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">  --hostname 192.168.1.222 \</span><br><span class="line">  --publish 443:443 --publish 80:80 --publish 22:22 \</span><br><span class="line">  --name gitlab \</span><br><span class="line">  --restart always \</span><br><span class="line">  --volume /data/gitlab/config:/etc/gitlab \</span><br><span class="line">  --volume /data/gitlab/logs:/var/log/gitlab \</span><br><span class="line">  --volume /data/gitlab/data:/var/opt/gitlab \</span><br><span class="line">  --network host \</span><br><span class="line">  gitlab/gitlab-ce:latest</span><br><span class="line"># 443 https访问端口,80 http访问端口, 22 docker容器端口.</span><br><span class="line"># /data/gitlab/config配置文件目录</span><br><span class="line"># /data/gitlab/logs日志存储目录</span><br><span class="line"># /data/gitlab/data应用数据存储目录</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>--env GITLAB_OMNIBUS_CONFIG=&quot;&quot;</code></p>
<p>该参数可以覆盖容器中GitLab的配置文件/etc/gitlab/gitlab.rb.具体参数详见<a href="https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template" target="_blank" rel="noopener">gitlab.rb.template</a></p>
</li>
</ul>
<h3 id="Language-translate"><a href="#Language-translate" class="headerlink" title="Language translate"></a>Language translate</h3><p>使用<a href="https://gitlab.com/xhang/gitlab" target="_blank" rel="noopener">xlang</a>提供的汉化包.</p>
<h5 id="测试汉化包"><a href="#测试汉化包" class="headerlink" title="测试汉化包"></a>测试汉化包</h5><p>我使用的gitlab版本是v11.3.5,在<a href="https://gitlab.com/xhang/gitlab" target="_blank" rel="noopener">xlang</a>的branch中只能找到11-3-stable-zh.所以我先进行了测试,看是否可用.(如何测试?可以按照这篇文章<a href="https://segmentfault.com/a/1190000016155088" target="_blank" rel="noopener">gitlab汉化</a>操作.)</p>
<p>实际上就是使用汉化包的文件替换<code>/opt/gitlab/embedded/service/gitlab-rails/</code>中的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cp -rf gitlab-11-3-stable-zh/* /opt/gitlab/embedded/service/gitlab-rails/</span><br><span class="line">$ gitlab-ctl reconfigure</span><br><span class="line">$ gitlab-ctl restart</span><br></pre></td></tr></table></figure>
<p>测试暂时没发现问题,就是使用11-3-stable-zh版本的汉化包.</p>
<h5 id="如何将汉化包加入容器"><a href="#如何将汉化包加入容器" class="headerlink" title="如何将汉化包加入容器?"></a>如何将汉化包加入容器?</h5><p>我用的是镜像,难道我将汉化包文件路径映射到容器中吗?好吧,来测试一把.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">  --hostname 192.168.1.222 \</span><br><span class="line">  --publish 443:443 --publish 80:80 --publish 22:22 \</span><br><span class="line">  --name gitlab \</span><br><span class="line">  --restart always \</span><br><span class="line">  --volume /data/gitlab/config:/etc/gitlab \</span><br><span class="line">  --volume /data/gitlab/logs:/var/log/gitlab \</span><br><span class="line">  --volume /data/gitlab/data:/var/opt/gitlab \</span><br><span class="line">  --volume /data/gitlab/data/zh/gitlab:/opt/gitlab/embedded/service/gitlab-rails \</span><br><span class="line">  --network host \</span><br><span class="line">  gitlab/gitlab-ce:11.3.5-ce.0</span><br></pre></td></tr></table></figure>
<p>结果悲剧了,一直不断自动重启.这种问题也不是我能解决的,只能先放弃了.</p>
<p>怎么办呢?搜索了一番,找到了<a href="https://hub.docker.com/u/twang2218/" target="_blank" rel="noopener">twang2218</a>/<a href="https://hub.docker.com/r/twang2218/gitlab-ce-zh/" target="_blank" rel="noopener">gitlab-ce-zh</a>提供的Dockerfile.</p>
<p>在twang2218的Dockerfile中找到了使用替换文件的操作</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fwi50jq12nj319k0lmn39.jpg" alt="image-20181023142449054"></p>
<p>既然twang2218能打包成功,说明Dockerfile是正确的.现在只要替换为我使用的版本和汉化包版本应该同样有效.(他山之石可以攻玉)</p>
<h5 id="构建汉化包镜像"><a href="#构建汉化包镜像" class="headerlink" title="构建汉化包镜像"></a>构建汉化包镜像</h5><h6 id="生成Dockerfile"><a href="#生成Dockerfile" class="headerlink" title="生成Dockerfile"></a>生成Dockerfile</h6><p>在github上直接Fork<a href="https://github.com/twang2218" target="_blank" rel="noopener">twang2218</a>/<strong>gitlab-ce-zh</strong>的代码,再clone到本地.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/steven-ji/gitlab-ce-zh.git</span><br></pre></td></tr></table></figure>
<p>修改version.sh文件,增加11.3.5</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ vim version.sh</span><br><span class="line">export VERSIONS=(</span><br><span class="line">    10.7.7</span><br><span class="line">    10.8.7</span><br><span class="line">    11.0.5</span><br><span class="line">    11.1.4</span><br><span class="line">    11.3.5</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>使用脚本生成Dockerfile文件.会生成<code>11.3</code>目录,并且里面有个Dockerfile文件.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./build generate 11.3</span><br></pre></td></tr></table></figure>
<p><strong>注:由于xlang提供v11.3.5的汉化包为11.3-stable-zh,所以需要修改Dockerfile文件中的v11.3.5-zh为11.3-stable-zh</strong></p>
<h6 id="通过docker-hub自动构建镜像"><a href="#通过docker-hub自动构建镜像" class="headerlink" title="通过docker hub自动构建镜像"></a>通过docker hub自动构建镜像</h6><p>关联github即可,具体操作忽略.</p>
<h5 id="使用汉化版gitlab"><a href="#使用汉化版gitlab" class="headerlink" title="使用汉化版gitlab"></a>使用汉化版gitlab</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull jilingjun1014/gitlab-zh:v11.3.5</span><br><span class="line">$ docker run -d \</span><br><span class="line">  --publish 443:443 --publish 80:80 --publish 22:22 \</span><br><span class="line">  --name gitlab \</span><br><span class="line">  --restart always \</span><br><span class="line">  --volume /data/gitlab/config:/etc/gitlab \</span><br><span class="line">  --volume /data/gitlab/logs:/var/log/gitlab \</span><br><span class="line">  --volume /data/gitlab/data:/var/opt/gitlab \</span><br><span class="line">  --network host \</span><br><span class="line">  jilingjun1014/gitlab-zh:v11.3.5</span><br></pre></td></tr></table></figure>
<h3 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h3><ul>
<li><a href="https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template" target="_blank" rel="noopener">gitlab.rb配置详情</a></li>
</ul>
<p>GitLab启动加载的配置文件为gitlab.rb,先创建出来.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ touch /data/gitlab/config/gitlab.rb</span><br></pre></td></tr></table></figure>
<h4 id="邮件通知配置"><a href="#邮件通知配置" class="headerlink" title="邮件通知配置"></a>邮件通知配置</h4><p>邮件的配置方式比较多,我的是以<strong>阿里云企业邮箱</strong>为主.(以下提供链接)</p>
<ul>
<li><a href="https://docs.gitlab.com/omnibus/settings/smtp.html" target="_blank" rel="noopener">SMTP</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gitlab_rails[&apos;gitlab_email_from&apos;] = &quot;username@company.com&quot;</span><br><span class="line">gitlab_rails[&apos;smtp_enable&apos;] = true</span><br><span class="line">gitlab_rails[&apos;smtp_address&apos;] = &quot;smtp.mxhichina.com&quot;</span><br><span class="line">gitlab_rails[&apos;smtp_port&apos;] = 465</span><br><span class="line">gitlab_rails[&apos;smtp_user_name&apos;] = &quot;username@company.com&quot;</span><br><span class="line">gitlab_rails[&apos;smtp_password&apos;] = &quot;password&quot;</span><br><span class="line">gitlab_rails[&apos;smtp_domain&apos;] = &quot;mxhichina.com&quot;</span><br><span class="line">gitlab_rails[&apos;smtp_authentication&apos;] = &quot;login&quot;</span><br><span class="line">gitlab_rails[&apos;smtp_enable_starttls_auto&apos;] = true</span><br><span class="line">gitlab_rails[&apos;smtp_tls&apos;] = true</span><br></pre></td></tr></table></figure>
<h5 id="测试邮箱"><a href="#测试邮箱" class="headerlink" title="测试邮箱"></a>测试邮箱</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ssh到Gitlab的docker容器中.</span><br><span class="line">$ docker exec -ti gitlab /bin/bash</span><br><span class="line">$ gitlab-rails console</span><br><span class="line">$ Notify.test_email(&apos;destination_email@address.com&apos;, &apos;Message Subject&apos;, &apos;Message Body&apos;).deliver_now</span><br></pre></td></tr></table></figure>
<h4 id="配置外部访问的URL"><a href="#配置外部访问的URL" class="headerlink" title="配置外部访问的URL"></a>配置外部访问的URL</h4><p>不使用内置的nginx时可以不配置.</p>
<ul>
<li>支持https</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 配置文件中添加如下,则访问GitLab的路径就是:http://gitlab.example.com</span><br><span class="line">external_url &quot;http://gitlab.example.com&quot;</span><br><span class="line">external_url &quot;https://gitlab.example.com&quot;</span><br><span class="line"># 重新加载配置</span><br><span class="line">$ gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>
<h4 id="配置端口"><a href="#配置端口" class="headerlink" title="配置端口"></a>配置端口</h4><ul>
<li><p>配置web访问端口</p>
<p>配置文件<code>external_url</code>属性指定.(实际上,修改的是容器内的端口)</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">external_url &quot;http://gitlab.example.com:9080&quot;</span><br><span class="line">external_url &quot;https://gitlab.example.com:9443&quot;</span><br></pre></td></tr></table></figure>
<p>如:访问端口为9080和9443,则在容器启动时,宿主机与容器的映射端口为<code>-p 9443:9443 -p 9080:9080</code></p>
<ul>
<li><p>配置容器ssh端口</p>
<p>配置文件:<code>gitlab_rails[&#39;gitlab_shell_ssh_port&#39;] = 9022</code></p>
</li>
</ul>
<h4 id="配置支持Https"><a href="#配置支持Https" class="headerlink" title="配置支持Https"></a>配置支持Https</h4><p>GitLab安装时默认绑定安装了一个内置的Nginx.</p>
<h5 id="使用内置Nginx"><a href="#使用内置Nginx" class="headerlink" title="使用内置Nginx"></a>使用内置Nginx</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># set access url</span><br><span class="line">external_url &quot;http://gitlab.example.com&quot;</span><br><span class="line">external_url &quot;https://gitlab.example.com&quot;</span><br><span class="line"># compatable http</span><br><span class="line">nginx[&apos;redirect_http_to_https&apos;] = true</span><br><span class="line"># set certs</span><br><span class="line">nginx[&apos;ssl_certificate&apos;] = &quot;/etc/gitlab/ssl/gitlab.example.com.crt&quot;</span><br><span class="line">nginx[&apos;ssl_certificate_key&apos;] = &quot;/etc/gitlab/ssl/gitlab.example.com.key&quot;</span><br><span class="line"># set errer page info</span><br><span class="line">nginx[&apos;custom_error_pages&apos;] = &#123;</span><br><span class="line">  &apos;404&apos; =&gt; &#123;</span><br><span class="line">    &apos;title&apos; =&gt; &apos;Example title&apos;,</span><br><span class="line">    &apos;header&apos; =&gt; &apos;Example header&apos;,</span><br><span class="line">    &apos;message&apos; =&gt; &apos;Example message&apos;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="使用外部Nginx"><a href="#使用外部Nginx" class="headerlink" title="使用外部Nginx"></a>使用外部Nginx</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 关闭内置nginx</span><br><span class="line">nginx[&apos;enable&apos;] = false</span><br><span class="line"># 配置访问用户.Debian/Ubuntu the default user is www-data for both Apache/Nginx whereas for RHEL/CentOS the Nginx user is nginx.</span><br><span class="line">web_server[&apos;external_users&apos;] = [&apos;www-data&apos;,&apos;nginx&apos;]</span><br><span class="line"># 配置nginx服务器ip白名单</span><br><span class="line">gitlab_rails[&apos;trusted_proxies&apos;] = [&apos;192.168.1.0/24&apos;, &apos;192.168.2.1&apos;, &apos;2001:0db8::/32&apos; ]</span><br><span class="line"># Define the external url</span><br><span class="line">external_url &apos;http://git.example.com&apos;</span><br><span class="line"># Disable the built-in nginx</span><br><span class="line">nginx[&apos;enable&apos;] = false</span><br><span class="line"># Disable the built-in unicorn</span><br><span class="line">unicorn[&apos;enable&apos;] = false</span><br><span class="line"># Set the internal API URL</span><br><span class="line">gitlab_rails[&apos;internal_api_url&apos;] = &apos;http://git.example.com&apos;</span><br><span class="line"># Define the web server process user (ubuntu/nginx)</span><br><span class="line">web_server[&apos;external_users&apos;] = [&apos;www-data&apos;]</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://docs.gitlab.com/omnibus/settings/nginx.html#enable-https" target="_blank" rel="noopener">Enable https</a></li>
</ul>
<h4 id="配置Git-Repository数据存储路径"><a href="#配置Git-Repository数据存储路径" class="headerlink" title="配置Git Repository数据存储路径"></a>配置Git Repository数据存储路径</h4><p>Git repository数据存储的默认路径是:/var/opt/gitlab/git-data.</p>
<p>注:如果采用了docker镜像方式,在启动时已经指定了宿主机的目录/data/gitlab/data,所以下面的配置可以不用.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># default修改存储目录,alternative增加一个存储目录</span><br><span class="line">git_data_dirs(&#123;</span><br><span class="line">  &quot;default&quot; =&gt; &#123; &quot;path&quot; =&gt; &quot;/var/opt/gitlab/git-data&quot; &#125;,</span><br><span class="line">  &quot;alternative&quot; =&gt; &#123; &quot;path&quot; =&gt; &quot;/mnt/nas/git-data&quot; &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="GitLab重新加载配置"><a href="#GitLab重新加载配置" class="headerlink" title="GitLab重新加载配置"></a>GitLab重新加载配置</h4><p>对配置的所有修改,都需要重载配置并重启.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab-ctl reconfigure</span><br><span class="line">$ gitlab-ctl restart</span><br></pre></td></tr></table></figure>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fw84q9ykaij30vy082gly.jpg" alt="image-20181014223921033"></p>
<h3 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h3><ul>
<li>mac 10.13.6, gitlab-ce 11.3.5-ce.0, docker 18.03.1-ce</li>
</ul>
<h3 id="Set-configuration"><a href="#Set-configuration" class="headerlink" title="Set configuration"></a>Set configuration</h3><h4 id="Set-Store-path、Suport-https、Set-emial"><a href="#Set-Store-path、Suport-https、Set-emial" class="headerlink" title="Set Store path、Suport https、Set emial"></a>Set Store path、Suport https、Set emial</h4><ul>
<li><p>配置文件路径:<code>/Users/jilingjun/Applications/data/gitlab/config</code></p>
<ul>
<li>ssl文件路径:<code>/Users/jilingjun/Applications/data/gitlab/config/ssl</code></li>
</ul>
</li>
<li><p>数据存储路径:<code>/Users/jilingjun/Applications/data/gitlab/data</code></p>
</li>
<li><p>日志存储路径:<code>/Users/jilingjun/Applications/data/log/gitlab</code></p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ vim /Users/jilingjun/Applications/data/gitlab/config/gitlab.rb</span><br><span class="line"># set access url</span><br><span class="line">external_url &quot;http://gitlab.example.com&quot;</span><br><span class="line">external_url &quot;https://gitlab.example.com&quot;</span><br><span class="line"># set ssh port</span><br><span class="line">gitlab_rails[&apos;gitlab_shell_ssh_port&apos;] = 9022</span><br><span class="line"># compatable http</span><br><span class="line">nginx[&apos;redirect_http_to_https&apos;] = true</span><br><span class="line"># set certs</span><br><span class="line">nginx[&apos;ssl_certificate&apos;] = &quot;/etc/gitlab/ssl/gitlab.example.com.crt&quot;</span><br><span class="line">nginx[&apos;ssl_certificate_key&apos;] = &quot;/etc/gitlab/ssl/gitlab.example.com.key&quot;</span><br><span class="line"># set errer page info</span><br><span class="line">nginx[&apos;custom_error_pages&apos;] = &#123;</span><br><span class="line">  &apos;404&apos; =&gt; &#123;</span><br><span class="line">    &apos;title&apos; =&gt; &apos;Example title&apos;,</span><br><span class="line">    &apos;header&apos; =&gt; &apos;Example header&apos;,</span><br><span class="line">    &apos;message&apos; =&gt; &apos;Example message&apos;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"># set email config.Here use aliyun enterprise mail.</span><br><span class="line">gitlab_rails[&apos;gitlab_email_from&apos;] = &quot;username@company.com&quot;</span><br><span class="line">gitlab_rails[&apos;smtp_enable&apos;] = true</span><br><span class="line">gitlab_rails[&apos;smtp_address&apos;] = &quot;smtp.mxhichina.com&quot;</span><br><span class="line">gitlab_rails[&apos;smtp_port&apos;] = 465</span><br><span class="line">gitlab_rails[&apos;smtp_user_name&apos;] = &quot;username@company.com&quot;</span><br><span class="line">gitlab_rails[&apos;smtp_password&apos;] = &quot;password&quot;</span><br><span class="line">gitlab_rails[&apos;smtp_domain&apos;] = &quot;mxhichina.com&quot;</span><br><span class="line">gitlab_rails[&apos;smtp_authentication&apos;] = &quot;login&quot;</span><br><span class="line">gitlab_rails[&apos;smtp_enable_starttls_auto&apos;] = true</span><br><span class="line">gitlab_rails[&apos;smtp_tls&apos;] = true</span><br></pre></td></tr></table></figure>
<h4 id="Generator-And-Use-self-certificate"><a href="#Generator-And-Use-self-certificate" class="headerlink" title="Generator And Use self certificate"></a>Generator And Use self certificate</h4><p>参考之前写的《生成自签名根证书》</p>
<h3 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">  --hostname 192.168.1.222 \</span><br><span class="line">  --publish 443:443 --publish 80:80 --publish 22:22 \</span><br><span class="line">  --name gitlab \</span><br><span class="line">  --restart always \</span><br><span class="line">  --volume /data/gitlab/config:/etc/gitlab \</span><br><span class="line">  --volume /data/gitlab/logs:/var/log/gitlab \</span><br><span class="line">  --volume /data/gitlab/data:/var/opt/gitlab \</span><br><span class="line">  --network host \</span><br><span class="line">  jilingjun1014/gitlab-zh:v11.3.5</span><br><span class="line">  </span><br><span class="line"># See gitlab container logs</span><br><span class="line">$ docker logs -f gitlab</span><br><span class="line"></span><br><span class="line"># Update Permission</span><br><span class="line">$ docker exec gitlab update-permissions</span><br><span class="line">$ docker restart gitlab</span><br><span class="line"></span><br><span class="line"># See gitlab container logs</span><br><span class="line">$ docker logs -f gitlab</span><br></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><h3 id="GitLab-Docker-Images"><a href="#GitLab-Docker-Images" class="headerlink" title="GitLab Docker Images"></a><a href="https://docs.gitlab.com/omnibus/docker/" target="_blank" rel="noopener">GitLab Docker Images</a></h3><h3 id="Gitlab汉化"><a href="#Gitlab汉化" class="headerlink" title="Gitlab汉化"></a><a href="https://segmentfault.com/a/1190000016155088" target="_blank" rel="noopener">Gitlab汉化</a></h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://steven-ji.github.io/blog/blog/2018/10/10/gh-ost使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="溏溏爸爸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ttbb玩代码">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2018/10/10/gh-ost使用/" itemprop="url">gh-ost使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-10T10:27:11+08:00">
                2018-10-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,891
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  16
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>生产上,有时需要对一些大表(几千万数据)的表中字段进行增、改操作.如果直接操作,很可能对线上有比较大的影响.很多时候,需要在非忙时(大多是凌晨)进行表修改.想想都折磨人.</p>
<p>这里记录使用工具<a href="https://github.com/github/gh-ost" target="_blank" rel="noopener">gh-ost</a>(go语言编写)进行表字段修改.</p>
<h3 id="为什么用它"><a href="#为什么用它" class="headerlink" title="为什么用它"></a>为什么用它</h3><ul>
<li>不影响线上性能,基于binary log的,异步的处理增量数据.而其他工具基于triggle.<a href="https://github.com/github/gh-ost/blob/master/doc/why-triggerless.md" target="_blank" rel="noopener">为什么不使用triggle?</a></li>
</ul>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><ul>
<li><p>伪装成一个mysql的从节点,读取binary log.</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fw42o0dt06j31bw0lgjxf.jpg" alt="gh-ost-general-flow"></p>
</li>
</ul>
<h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><p>在阿里云上的一台mysql,一张2000w数据的表,需要增加一个int型字段.</p>
<p>使用gh-ost,耗时37分钟.</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul>
<li>mysql 5.7.15-log (阿里云)</li>
<li>gh-ost 1.0.46</li>
</ul>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h3><ul>
<li>If you mysql already using RBR, all is well for you</li>
<li>If not, convert one of your replicas to <code>binlog_format=&#39;ROW&#39;</code>, or let <code>gh-ost</code> do this for you.<code>gh-ost</code> <strong>will not</strong> convert back to <code>STATEMENT</code> (SBR)</li>
<li>Replica should support log-slave-updates.</li>
</ul>
<p>所以,gh-ost建议连接到mysql的从节点上.原因如上:如果binary log为statement模式时,gh-ost会强制转换到row模式,且需要自己手动改回statement.(注: gh-ost参数中配置–switch-to-rbr)</p>
<h3 id="limitations"><a href="#limitations" class="headerlink" title="limitations"></a>limitations</h3><ul>
<li>使用具有管理员账号的权限.</li>
</ul>
<ul>
<li>gh-ost对表名大小写不敏感,如待迁移的表名为:MyTable,且存在一张表为Mytable,则不能使用.</li>
</ul>
<ul>
<li><p>表需要存在主键,且主键的值不是null,否则需要在gh-ost参数中添加<code>--allow-nullable-unique-key</code>.一般表的id都设置为自增主键,通用场景不用考虑这种问题.<a href="https://github.com/github/gh-ost/blob/master/doc/shared-key.md" target="_blank" rel="noopener">Read more</a></p>
</li>
<li><p>如果gh-ost连接的是从节点,需要确保主从节点上两张表的表结构一直.</p>
</li>
<li>使用google云数据库,参数添加 <code>--gcp</code></li>
<li>使用阿里云的RDS,参数添加 <code>--aliyun-rds</code> </li>
<li>对表重命名不能使用</li>
</ul>
<h3 id="Install-and-Use"><a href="#Install-and-Use" class="headerlink" title="Install and Use"></a>Install and Use</h3><ul>
<li><a href="https://github.com/github/gh-ost/releases" target="_blank" rel="noopener">download</a></li>
</ul>
<p>下载完成后解压后直接使用即可.</p>
<p>使用的关键是相关参数的设置及理解.参数的详细信息通过<code>./gh-ost --help</code>查看即可.这里我也罗列了详见附录gh-ost参数详解.</p>
<p>这里记录下我迁移中设置的相关参数.</p>
<h4 id="阿里云RDS且无从节点"><a href="#阿里云RDS且无从节点" class="headerlink" title="阿里云RDS且无从节点"></a>阿里云RDS且无从节点</h4><ul>
<li><p>阿里云的RDS,需要添加参数–aliyun-rds</p>
</li>
<li><p>无从节点,直接在主节点上执行–allow-on-master</p>
</li>
</ul>
<h5 id="Check-binlog-format"><a href="#Check-binlog-format" class="headerlink" title="Check binlog_format"></a>Check binlog_format</h5><p>检查mysql的binary log格式(FULL也是支持的).如果是statement,需要添加–switch-to-rbr参数,且最后需要手动将binlog_format设置回statement格式.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ show variables like &apos;binlog_format&apos;;</span><br><span class="line">+-----------------------------------------+--------------------------------+</span><br><span class="line">| Variable_name                           | Value                          |</span><br><span class="line">+-----------------------------------------+--------------------------------+</span><br><span class="line">| binlog_format                           | ROW                            |</span><br></pre></td></tr></table></figure>
<h5 id="Run-migrate"><a href="#Run-migrate" class="headerlink" title="Run migrate"></a>Run migrate</h5><ul>
<li><a href="https://github.com/github/gh-ost/blob/master/doc/cut-over.md" target="_blank" rel="noopener">cut-over</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">./gh-ost \</span><br><span class="line">--aliyun-rds=true \</span><br><span class="line">--allow-on-master \</span><br><span class="line">--host= --port= --database= --table= --conf=/opt/account.cnf \</span><br><span class="line">--alter=&quot;ADD COLUMN platform int(2) DEFAULT NULL COMMENT &apos;所属平台&apos;&quot; \</span><br><span class="line">--chunk-size=5000 \</span><br><span class="line">--concurrent-rowcount \</span><br><span class="line">--cut-over=atomic \</span><br><span class="line">--cut-over-lock-timeout-seconds=3 \</span><br><span class="line">--initially-drop-ghost-table=true \</span><br><span class="line">--initially-drop-old-table=true \</span><br><span class="line">--initially-drop-socket-file=true \</span><br><span class="line">--timestamp-old-table=true \</span><br><span class="line">--verbose \</span><br><span class="line">--serve-socket-file=/tmp/gh-ost.test.sock \</span><br><span class="line">--switch-to-rbr \</span><br><span class="line">--execute</span><br><span class="line"></span><br><span class="line"># --conf设置登录mysql的用户名和密码文件的绝对路径.内容格式如下.</span><br><span class="line">[client]</span><br><span class="line">user=gh-ost</span><br><span class="line">password=123456</span><br><span class="line"># --aliyun-rds=true针对使用阿里云的RDS.</span><br><span class="line"># --allow-on-master没有从节点时,直接连接主mysql时指定.</span><br><span class="line"># --alter表结构操作,如我这里添加字段&quot;ADD COLOUM platform int(2) DEFAULT NULL COMMENT &apos;所属平台&apos;&quot;</span><br><span class="line"># --chunk-size每次复制数据的数量,默认是1000,允许100~100,000之间.</span><br><span class="line"># --concurrent-rowcount一边复制数据一边计算数据量</span><br><span class="line"># --cut-over数据复制的最后一步,安全的对原表和新表进行切换.默认是atomic,而two-step则不安全.</span><br><span class="line"># --cut-over-lock-timeout-seconds执行cut-over时间.默认3秒,可以不用配置.</span><br><span class="line"># --cut-over-exponential-backoff执行cut-over失败后执行指数级等待.</span><br><span class="line"># --exponential-backoff-max-interval执行指数级等待的最大时间间隔.默认是64.如:</span><br><span class="line"># --exact-rowcount真实计算数据总量,执行count()操作.个人觉得没必要,比较耗时.</span><br><span class="line"># --initially-drop-ghost-table(建议使用)清除以前操作遗留下的ghost表</span><br><span class="line"># --initially-drop-old-table(建议使用)清除以前操作遗留下的旧表</span><br><span class="line"># --initially-drop-socket-file(建议使用)清除以前遗留的socket文件</span><br><span class="line"># --timestamp-old-table旧表加上时间戳</span><br><span class="line"># --verbose日志界别debug</span><br><span class="line"># --serve-socket-file=/tmp/gh-ost.test.sock </span><br><span class="line"># --panic-flag-file=/tmp/gh-ost.panic.flag(暂时不清楚,先不使用)</span><br><span class="line"># --switch-to-rbr(建议添加)这样不用关注mysql的bin log的格式.让gh-ost去执行设置bin-log格式操作.</span><br></pre></td></tr></table></figure>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="gh-ost参数详解"><a href="#gh-ost参数详解" class="headerlink" title="gh-ost参数详解"></a>gh-ost参数详解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">-aliyun-rds</span><br><span class="line">  	set to &apos;true&apos; when you execute on Aliyun RDS.</span><br><span class="line">-allow-master-master</span><br><span class="line">  	explicitly allow running in a master-master setup</span><br><span class="line">-allow-nullable-unique-key</span><br><span class="line">  	allow gh-ost to migrate based on a unique key with nullable columns. As long as no NULL values exist, this should be OK. If NULL values exist in chosen key, data may be corrupted. Use at your own risk!</span><br><span class="line">-allow-on-master</span><br><span class="line">  	allow this migration to run directly on master. Preferably it would run on a replica</span><br><span class="line">-alter string</span><br><span class="line">  	alter statement (mandatory)</span><br><span class="line">-approve-renamed-columns ALTER</span><br><span class="line">  	in case your ALTER statement renames columns, gh-ost will note that and offer its interpretation of the rename. By default gh-ost does not proceed to execute. This flag approves that gh-ost&apos;s interpretation is correct</span><br><span class="line">-ask-pass</span><br><span class="line">  	prompt for MySQL password</span><br><span class="line">-assume-master-host string</span><br><span class="line">  	(optional) explicitly tell gh-ost the identity of the master. Format: some.host.com[:port] This is useful in master-master setups where you wish to pick an explicit master, or in a tungsten-replicator where gh-ost is unable to determine the master</span><br><span class="line">-assume-rbr</span><br><span class="line">  	set to &apos;true&apos; when you know for certain your server uses &apos;ROW&apos; binlog_format. gh-ost is unable to tell, event after reading binlog_format, whether the replication process does indeed use &apos;ROW&apos;, and restarts replication to be certain RBR setting is applied. Such operation requires SUPER privileges which you might not have. Setting this flag avoids restarting replication and you can proceed to use gh-ost without SUPER privileges</span><br><span class="line">-check-flag</span><br><span class="line">  	Check if another flag exists/supported. This allows for cross-version scripting. Exits with 0 when all additional provided flags exist, nonzero otherwise. You must provide (dummy) values for flags that require a value. Example: gh-ost --check-flag --cut-over-lock-timeout-seconds --nice-ratio 0</span><br><span class="line">-chunk-size int</span><br><span class="line">  	amount of rows to handle in each iteration (allowed range: 100-100,000) (default 1000)</span><br><span class="line">-concurrent-rowcount</span><br><span class="line">  	(with --exact-rowcount), when true (default): count rows after row-copy begins, concurrently, and adjust row estimate later on; when false: first count rows, then start row copy (default true)</span><br><span class="line">-conf string</span><br><span class="line">  	Config file</span><br><span class="line">-critical-load string</span><br><span class="line">  	Comma delimited status-name=threshold, same format as --max-load. When status exceeds threshold, app panics and quits</span><br><span class="line">-critical-load-hibernate-seconds int</span><br><span class="line">  	When nonzero, critical-load does not panic and bail out; instead, gh-ost goes into hibernate for the specified duration. It will not read/write anything to from/to any server</span><br><span class="line">-critical-load-interval-millis int</span><br><span class="line">  	When 0, migration immediately bails out upon meeting critical-load. When non-zero, a second check is done after given interval, and migration only bails out if 2nd check still meets critical load</span><br><span class="line">-cut-over string</span><br><span class="line">  	choose cut-over type (default|atomic, two-step) (default &quot;atomic&quot;)</span><br><span class="line">-cut-over-exponential-backoff</span><br><span class="line">  	Wait exponentially longer intervals between failed cut-over attempts. Wait intervals obey a maximum configurable with &apos;exponential-backoff-max-interval&apos;).</span><br><span class="line">-cut-over-lock-timeout-seconds int</span><br><span class="line">  	Max number of seconds to hold locks on tables while attempting to cut-over (retry attempted when lock exceeds timeout) (default 3)</span><br><span class="line">-database string</span><br><span class="line">  	database name (mandatory)</span><br><span class="line">-debug</span><br><span class="line">  	debug mode (very verbose)</span><br><span class="line">-default-retries int</span><br><span class="line">  	Default number of retries for various operations before panicking (default 60)</span><br><span class="line">-discard-foreign-keys</span><br><span class="line">  	DANGER! This flag will migrate a table that has foreign keys and will NOT create foreign keys on the ghost table, thus your altered table will have NO foreign keys. This is useful for intentional dropping of foreign keys</span><br><span class="line">-dml-batch-size int</span><br><span class="line">  	batch size for DML events to apply in a single transaction (range 1-100) (default 10)</span><br><span class="line">-exact-rowcount</span><br><span class="line">  	actually count table rows as opposed to estimate them (results in more accurate progress estimation)</span><br><span class="line">-execute</span><br><span class="line">  	actually execute the alter &amp; migrate the table. Default is noop: do some tests and exit</span><br><span class="line">-exponential-backoff-max-interval int</span><br><span class="line">  	Maximum number of seconds to wait between attempts when performing various operations with exponential backoff. (default 64)</span><br><span class="line">-force-named-cut-over</span><br><span class="line">  	When true, the &apos;unpostpone|cut-over&apos; interactive command must name the migrated table</span><br><span class="line">-force-table-names string</span><br><span class="line">  	table name prefix to be used on the temporary tables</span><br><span class="line">-heartbeat-interval-millis int</span><br><span class="line">  	how frequently would gh-ost inject a heartbeat value (default 100)</span><br><span class="line">-help</span><br><span class="line">  	Display usage</span><br><span class="line">-hooks-hint string</span><br><span class="line">  	arbitrary message to be injected to hooks via GH_OST_HOOKS_HINT, for your convenience</span><br><span class="line">-hooks-path string</span><br><span class="line">  	directory where hook files are found (default: empty, ie. hooks disabled). Hook files found on this path, and conforming to hook naming conventions will be executed</span><br><span class="line">-host string</span><br><span class="line">  	MySQL hostname (preferably a replica, not the master) (default &quot;127.0.0.1&quot;)</span><br><span class="line">-initially-drop-ghost-table</span><br><span class="line">  	Drop a possibly existing Ghost table (remains from a previous run?) before beginning operation. Default is to panic and abort if such table exists</span><br><span class="line">-initially-drop-old-table</span><br><span class="line">  	Drop a possibly existing OLD table (remains from a previous run?) before beginning operation. Default is to panic and abort if such table exists</span><br><span class="line">-initially-drop-socket-file</span><br><span class="line">  	Should gh-ost forcibly delete an existing socket file. Be careful: this might drop the socket file of a running migration!</span><br><span class="line">-master-password string</span><br><span class="line">  	MySQL password on master, if different from that on replica. Requires --assume-master-host</span><br><span class="line">-master-user string</span><br><span class="line">  	MySQL user on master, if different from that on replica. Requires --assume-master-host</span><br><span class="line">-max-lag-millis int</span><br><span class="line">  	replication lag at which to throttle operation (default 1500)</span><br><span class="line">-max-load string</span><br><span class="line">  	Comma delimited status-name=threshold. e.g: &apos;Threads_running=100,Threads_connected=500&apos;. When status exceeds threshold, app throttles writes</span><br><span class="line">-migrate-on-replica</span><br><span class="line">  	Have the migration run on a replica, not on the master. This will do the full migration on the replica including cut-over (as opposed to --test-on-replica)</span><br><span class="line">-nice-ratio float</span><br><span class="line">  	force being &apos;nice&apos;, imply sleep time per chunk time; range: [0.0..100.0]. Example values: 0 is aggressive. 1: for every 1ms spent copying rows, sleep additional 1ms (effectively doubling runtime); 0.7: for every 10ms spend in a rowcopy chunk, spend 7ms sleeping immediately after</span><br><span class="line">-ok-to-drop-table</span><br><span class="line">  	Shall the tool drop the old table at end of operation. DROPping tables can be a long locking operation, which is why I&apos;m not doing it by default. I&apos;m an online tool, yes?</span><br><span class="line">-panic-flag-file string</span><br><span class="line">  	when this file is created, gh-ost will immediately terminate, without cleanup</span><br><span class="line">-password string</span><br><span class="line">  	MySQL password</span><br><span class="line">-port int</span><br><span class="line">  	MySQL port (preferably a replica, not the master) (default 3306)</span><br><span class="line">-postpone-cut-over-flag-file string</span><br><span class="line">  	while this file exists, migration will postpone the final stage of swapping tables, and will keep on syncing the ghost table. Cut-over/swapping would be ready to perform the moment the file is deleted.</span><br><span class="line">-quiet</span><br><span class="line">  	quiet</span><br><span class="line">-replica-server-id uint</span><br><span class="line">  	server id used by gh-ost process. Default: 99999 (default 99999)</span><br><span class="line">-replication-lag-query string</span><br><span class="line">  	Deprecated. gh-ost uses an internal, subsecond resolution query</span><br><span class="line">-serve-socket-file string</span><br><span class="line">  	Unix socket file to serve on. Default: auto-determined and advertised upon startup</span><br><span class="line">-serve-tcp-port int</span><br><span class="line">  	TCP port to serve on. Default: disabled</span><br><span class="line">-skip-foreign-key-checks</span><br><span class="line">  	set to &apos;true&apos; when you know for certain there are no foreign keys on your table, and wish to skip the time it takes for gh-ost to verify that</span><br><span class="line">-skip-renamed-columns ALTER</span><br><span class="line">  	in case your ALTER statement renames columns, gh-ost will note that and offer its interpretation of the rename. By default gh-ost does not proceed to execute. This flag tells gh-ost to skip the renamed columns, i.e. to treat what gh-ost thinks are renamed columns as unrelated columns. NOTE: you may lose column data</span><br><span class="line">-stack</span><br><span class="line">  	add stack trace upon error</span><br><span class="line">-switch-to-rbr</span><br><span class="line">  	let this tool automatically switch binary log format to &apos;ROW&apos; on the replica, if needed. The format will NOT be switched back. I&apos;m too scared to do that, and wish to protect you if you happen to execute another migration while this one is running</span><br><span class="line">-table string</span><br><span class="line">  	table name (mandatory)</span><br><span class="line">-test-on-replica</span><br><span class="line">  	Have the migration run on a replica, not on the master. At the end of migration replication is stopped, and tables are swapped and immediately swap-revert. Replication remains stopped and you can compare the two tables for building trust</span><br><span class="line">-test-on-replica-skip-replica-stop</span><br><span class="line">  	When --test-on-replica is enabled, do not issue commands stop replication (requires --test-on-replica)</span><br><span class="line">-throttle-additional-flag-file string</span><br><span class="line">  	operation pauses when this file exists; hint: keep default, use for throttling multiple gh-ost operations (default &quot;/tmp/gh-ost.throttle&quot;)</span><br><span class="line">-throttle-control-replicas string</span><br><span class="line">  	List of replicas on which to check for lag; comma delimited. Example: myhost1.com:3306,myhost2.com,myhost3.com:3307</span><br><span class="line">-throttle-flag-file string</span><br><span class="line">  	operation pauses when this file exists; hint: use a file that is specific to the table being altered</span><br><span class="line">-throttle-http string</span><br><span class="line">  	when given, gh-ost checks given URL via HEAD request; any response code other than 200 (OK) causes throttling; make sure it has low latency response</span><br><span class="line">-throttle-query string</span><br><span class="line">  	when given, issued (every second) to check if operation should throttle. Expecting to return zero for no-throttle, &gt;0 for throttle. Query is issued on the migrated server. Make sure this query is lightweight</span><br><span class="line">-timestamp-old-table</span><br><span class="line">  	Use a timestamp in old table name. This makes old table names unique and non conflicting cross migrations</span><br><span class="line">-tungsten</span><br><span class="line">  	explicitly let gh-ost know that you are running on a tungsten-replication based topology (you are likely to also provide --assume-master-host)</span><br><span class="line">-user string</span><br><span class="line">  	MySQL user</span><br><span class="line">-verbose</span><br><span class="line">  	verbose</span><br><span class="line">-version</span><br><span class="line">  	Print version &amp; exit</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><p><a href="https://github.com/github/gh-ost" target="_blank" rel="noopener">gh-ost github</a></p>
</li>
<li><p><a href="https://www.cnblogs.com/zhoujinyi/p/9187421.html" target="_blank" rel="noopener">MySQL在线DDL gh-ost 使用说明</a></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://steven-ji.github.io/blog/blog/2018/09/17/ansible使用常见问题汇总-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="溏溏爸爸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ttbb玩代码">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2018/09/17/ansible使用常见问题汇总-md/" itemprop="url">ansible使用常见问题汇总.md</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-17T15:29:25+08:00">
                2018-09-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  105
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Cannot-have-both-the-docker-py-and-docker-python-modules-installed-together"><a href="#Cannot-have-both-the-docker-py-and-docker-python-modules-installed-together" class="headerlink" title="Cannot have both the docker-py and docker python modules installed together"></a>Cannot have both the docker-py and docker python modules installed together</h2><p>问题很明显,目标服务器pip即安装了docker-py又安装了docker,解决办法:两者都写在后,重新安装docker-py.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 查询版本</span><br><span class="line">$ pip show docker-py</span><br><span class="line">$ pip show docker</span><br><span class="line"># 卸载,同理pip、pip2、pip3</span><br><span class="line">$ pip uninstall docker</span><br><span class="line">$ pip uninstall docker-py</span><br><span class="line">$ pip uninstall docker-compose</span><br><span class="line"># 安装(--ignore-installed)</span><br><span class="line">$ pip install &apos;docker-compose&gt;=1.7.0&apos;</span><br><span class="line">$ pip install &apos;docker-py&gt;=1.7.0&apos;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/5/">5</a><a class="extend next" rel="next" href="/blog/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/blog/uploads/avatar.png"
                alt="溏溏爸爸" />
            
              <p class="site-author-name" itemprop="name">溏溏爸爸</p>
              <p class="site-description motion-element" itemprop="description">向终身学习者致敬</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/blog/archives/">
              
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/blog/categories/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/blog/tags/index.html">
                  <span class="site-state-item-count">50</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/steven-ji" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">溏溏爸爸</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">35.0k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/blog/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/blog/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/blog/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1s');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  


  <a href="https://github.com/steven-ji"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
</body>
</html>
